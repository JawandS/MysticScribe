outline_task:
  description: >
    You are the architect agent responsible for creating detailed chapter outlines. Follow this workflow:
    
    1. CONTEXT CHECK: First, analyze all available story context for chapter {chapter_number}:
       - Use the Knowledge Lookup tool to review relevant story elements
       - Use the Chapter Analysis tool to check for any existing draft material
       - CRITICAL: Use the Previous Chapter Reader tool to read and analyze all previously written chapters, with special focus on how the previous chapter ended
       - Consider the overall story progression and how this chapter fits
    
    2. OUTLINE HANDLING: Use the Outline Management tool to:
       - Check if an existing outline exists for this chapter
       - If existing outline found and action is 'expand': Load and enhance it with more detail and structure
       - If no existing outline or action is 'create_new': Generate a completely new outline
    
    Available Context:
    {knowledge_context}
    
    Previous Chapter Context (CRITICAL for continuity):
    {previous_chapter_context}
    
    Existing Draft Material (if any):
    {existing_draft}
    
    Existing Outline (if expanding):
    {existing_outline}
    
    Action to take: {outline_action}
    
    Create a detailed outline for chapter {chapter_number} that includes:
    - Opening scene that DIRECTLY continues from where the previous chapter ended (emotional state, location, immediate situation)
    - Seamless transition that addresses any cliffhangers or unresolved tensions from the previous chapter
    - Key plot points and story progression for this specific chapter that build naturally on previous events
    - Character development moments that acknowledge and build upon their state at the end of the previous chapter
    - World-building elements that maintain consistency with established details
    - Dialogue opportunities that reference recent events and maintain character relationship continuity
    - Action sequences or dramatic moments that feel like natural progression
    - Chapter climax that creates new tension while resolving elements from the previous chapter
    - Setup for the next chapter that maintains story momentum
    
    If expanding an existing outline, enhance it with:
    - Stronger continuity connections to the previous chapter's ending
    - More detailed scene descriptions that acknowledge character states and situations
    - Deeper character motivations that build on recent developments
    - Specific dialogue topics that reference recent events and emotional beats
    - Enhanced pacing notes that create smooth transition from previous chapter
    - Better integration with story knowledge base and previous chapter events
    - Clearer connections to character development and plot threads from previous chapters
    
    CONTINUITY REQUIREMENTS:
    - Chapter must begin exactly where the previous chapter ended (same emotional tone, immediate situation)
    - Address any cliffhangers or unresolved tensions immediately or acknowledge why they're being delayed
    - Reference the character's emotional/physical state from the previous chapter's conclusion
    - Maintain location continuity or provide clear, logical scene transitions
    - Build upon relationship dynamics and tensions established in previous chapters
    
    Target the outline to guide writing a chapter of 2000-4000 words that meaningfully advances the story while maintaining perfect continuity.
    
    IMPORTANT: You must return a complete, detailed chapter outline as your final answer. Do not just provide analysis or comments.
  expected_output: >
    A comprehensive outline for chapter {chapter_number} with:
    - Scene-by-scene breakdown (3-5 scenes typically)
    - Character motivations and development arcs for this chapter
    - Key dialogue topics and emotional beats
    - World-building details to weave naturally into the narrative
    - Pacing notes and estimated word count per section
    - Clear connection points to previous and next chapters
    - Specific story elements from the knowledge base to incorporate
    - References to events, character development, and plot threads from previous chapters
    
    The outline should be structured, detailed, and ready for the writer agent to use as a comprehensive guide.
    If this was an expansion of an existing outline, it should show clear improvements and additional depth.
  agent: architect
  async: false

writing_task:
  description: >
    Using the detailed chapter outline provided by the architect (either from the outline workflow or existing), 
    write a complete chapter in engaging prose that maintains perfect continuity with previous chapters.
    
    Available Context:
    {knowledge_context}
    
    Previous Chapter Context (CRITICAL for continuity):
    {previous_chapter_context}
    
    Chapter Outline to Follow:
    {approved_outline}
    
    CONTINUITY REQUIREMENTS:
    Before writing, you MUST use the Previous Chapter Reader tool to understand exactly how the previous chapter ended.
    Your opening must seamlessly continue from that exact point - same emotional state, immediate situation, and location.
    
    Focus on:
    - Opening that flows directly from the previous chapter's ending (same tone, immediate continuation of situation)
    - Bringing characters to life with authentic dialogue that references recent events and maintains relationship dynamics
    - Creating immersive descriptions that maintain consistency with established settings and world-building
    - Maintaining consistent voice and style throughout while building on previous character development
    - Following the outline structure while ensuring smooth transitions from the previous chapter
    - Building tension and emotional engagement that acknowledges character states from previous events
    - Ensuring narrative flow that feels like one continuous story, not separate episodes
    - Incorporating world-building elements naturally while maintaining established consistency
    - Advancing character arcs that build logically on recent developments and interactions
    - Creating compelling scenes that reference and build upon previous chapter events
    - Resolving or acknowledging any cliffhangers or tensions from the previous chapter
    
    The chapter should feel like a natural, immediate continuation of the story and maintain perfect consistency
    with the established world, characters, relationships, and recent events from previous chapters.
    
    CRITICAL: Do not start fresh or reset the situation. Continue exactly where the story left off.
  expected_output: >
    A complete chapter draft of approximately 2000-4000 words written in engaging prose.
    The chapter should be publication-ready in terms of storytelling quality and should 
    capture the essence of the outline while allowing for natural character interactions, 
    vivid descriptions, and a compelling narrative arc. The writing should be immersive,
    emotionally engaging, and move the story forward meaningfully.
  agent: writer

editing_task:
  description: >
    You're the line editor on a novel-in-progress. Your job is to take a drafted chapter—written from a detailed, approved outline—and refine it to feel like professionally published fiction while ensuring perfect continuity with previous chapters.
    Remove the use of "-" (dashes) or other common AI hallmarks that make it feel like an AI-generated text.

    This is Chapter {chapter_number}, with a target length of 2000-4000 words. Your edits should elevate the writing while preserving the author's original voice and intention.

    Previous Chapter Context (for continuity checking):
    {previous_chapter_context}

    CONTINUITY VERIFICATION:
    Use the Previous Chapter Reader tool to verify that the chapter maintains perfect continuity with previous chapters, especially:
    - Opening connects seamlessly to how the previous chapter ended
    - Character emotional states and relationships are consistent
    - Location and setting details remain consistent
    - Recent events are properly referenced or acknowledged
    - No contradictions with established plot points or character development

    Focus on:
    - Enhancing prose for clarity, rhythm, and emotional resonance while maintaining continuity
    - Making dialogue feel authentic, character-specific, and consistent with recent interactions
    - Avoid making setence starts too formulaic or repetitive
    - Weaving world-building naturally into scenes without contradicting established elements
    - Strengthening scene transitions, especially the opening transition from the previous chapter
    - Identifying and fixing tonal inconsistencies or continuity breaks
    - Cutting overly verbose sections and expanding thin areas where needed, especially around continuity points
    - Ensuring the chapter hits a satisfying emotional or plot beat at the end while setting up natural continuation
    - Keeping everything grounded in the broader story context and recent chapter events

    Avoid over-sanitizing the voice. Don't flatten the style or explain things the reader can infer. Treat the manuscript like a serious literary work with genre expectations rooted in fantasy and Xianxia. You are not rewriting, you are refining while ensuring seamless story flow.
    Make sure the final product feels like it was written by an experienced human author and flows naturally from previous chapters.
  expected_output: >
    A clean, publication-ready chapter between 2000-4000 words that reads like it came from an experienced human author and maintains perfect continuity with previous chapters. The final version should have strong narrative flow that connects seamlessly to previous events, emotionally grounded character moments that build on recent developments, immersive world details that remain consistent with established elements, and precise, vivid prose. The chapter should feel like a natural continuation of the ongoing story, not a standalone piece. Return the full edited chapter only—no commentary or preamble.
  agent: editor

polishing_task:
  description: >
    You are the final polisher responsible for transforming the edited chapter into completely natural, 
    human-feeling prose that captures the authentic voice and style of fantasy/xianxia literature.
    Your job is to eliminate every trace of AI generation while preserving the story's quality and essence.
    
    Chapter {chapter_number} has been written and edited but may still contain AI-generated patterns.
    
    Previous Chapter Context (for style consistency):
    {previous_chapter_context}
    
    MANDATORY PREPARATION STEPS:
    1. Use the Style Analysis tool to get detailed analysis of writing patterns from previous chapters
    2. Use the Previous Chapter Reader tool to read the content and context from earlier chapters
    3. Use the Style Guide tool to review general guidelines for areas needing focus
    4. Compare the current chapter's style against the analyzed patterns from previous chapters
    
    STYLE ANALYSIS FROM PREVIOUS CHAPTERS:
    Before polishing, analyze previous chapters for:
    - Specific sentence structure patterns and rhythms (e.g., mixing short impactful sentences with flowing longer ones)
    - Distinctive metaphor and imagery styles (e.g., "Dawn... was a blade of cold air", "mist coiled like a sleeping dragon")
    - Character voice patterns and dialogue authenticity
    - Atmospheric description techniques and sensory detail usage
    - Balance between intimate character moments and epic world-building
    - Specific vocabulary choices and terminology usage
    - Pacing techniques between action, dialogue, and description
    - Emotional beat patterns and how feelings are conveyed
    
    STYLE MATCHING REQUIREMENTS:
    - Mirror the established sentence rhythm patterns from previous chapters
    - Use similar metaphorical language and imagery style
    - Maintain the same level of atmospheric detail and sensory immersion
    - Match the established balance between poetic and accessible language
    - Keep character dialogue consistent with their established voices
    - Preserve the established pacing patterns between action and contemplation
    - Use similar paragraph structure and break patterns
    - Maintain the established emotional authenticity style
    
    GENRE-SPECIFIC STYLE REQUIREMENTS:
    - Embrace the immersive, atmospheric quality of fantasy literature
    - Use vivid sensory details that ground readers in the world
    - Create natural dialogue that reflects character personalities and relationships
    - Balance poetic language with accessibility and clarity
    - Vary pacing between action sequences and quieter character moments
    - Infuse scenes with emotional authenticity and genuine character development
    
    AI PATTERN ELIMINATION:
    - Remove robotic or formulaic sentence structures (avoid repetitive patterns)
    - Vary sentence length organically to match the established style
    - Eliminate overused transitional phrases when they feel artificial ("meanwhile," "however," "nevertheless")
    - Replace generic descriptive language with specific, evocative details that match previous chapters
    - Remove redundant explanations or over-clarification
    - Eliminate any overly polished or "perfect" phrasing that lacks human nuance
    
    HUMANIZATION TECHNIQUES:
    - Add subtle imperfections that make prose feel genuinely human-authored
    - Create natural speech patterns with interruptions, hesitations, and realistic flow that match established character voices
    - Use paragraph breaks that mirror natural thought patterns and match previous chapter pacing
    - Make action sequences feel immediate and visceral, consistent with previous action scenes
    - Ensure character thoughts and internal monologue sound authentic to their established personality
    - Include small details and observations that feel organically human and fit the established style
    - Create emotional beats that feel genuine and consistent with previous emotional authenticity
    
    FANTASY/XIANXIA STYLE ELEMENTS:
    - Maintain the epic scope while keeping character moments intimate (matching previous chapters)
    - Use language that feels both timeless and accessible (consistent with established tone)
    - Create atmosphere through sensory details (sounds, smells, textures) in the same style as previous chapters
    - Balance mystical elements with grounded human emotions (matching established approach)
    - Ensure world-building details feel naturally integrated, not forced (consistent with previous integration style)
    - Make cultivation/magic systems feel lived-in rather than explained (matching previous treatment)
    
    STYLE CONSISTENCY VERIFICATION:
    - Double-check that the polished chapter could seamlessly follow the previous chapter stylistically
    - Ensure no jarring differences in voice, tone, or writing technique
    - Verify that a reader wouldn't notice any shift in author "voice" between chapters
    - Confirm that descriptive techniques, dialogue patterns, and pacing match established style
    
    CRITICAL: The goal is not to rewrite but to humanize and stylize while maintaining perfect consistency 
    with the established prose style from previous chapters. Preserve all story content, plot points, 
    character development, and world-building while transforming the prose style to feel like it was 
    crafted by the same skilled fantasy author who wrote the previous chapters.
    
    Make the text feel so naturally human and stylistically consistent that readers experience seamless 
    continuation of the same authorial voice throughout the entire story.
  expected_output: >
    A completely humanized and stylistically polished chapter of 2000-4000 words that reads with the 
    natural flow, authenticity, and atmospheric quality of professional fantasy literature. The text 
    should feel genuinely crafted by the same skilled human fantasy author who wrote previous chapters, 
    with no traces of AI generation patterns and perfect stylistic consistency. The prose should be 
    immersive, emotionally engaging, and indistinguishable in style from previous chapters. All story 
    elements, character development, and plot advancement should be preserved while the prose style 
    feels completely natural, human, and seamlessly consistent with the established authorial voice. 
    Return only the final polished chapter with no commentary.
  agent: polisher
