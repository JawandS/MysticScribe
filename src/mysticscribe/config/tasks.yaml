outline_task:
  description: >
    You are the architect agent responsible for creating detailed chapter outlines. Follow this workflow:
    
    1. CONTEXT CHECK: First, analyze all available story context for chapter {chapter_number}:
       - Use the Knowledge Lookup tool to review relevant story elements
       - Use the Chapter Analysis tool to check for any existing draft material
       - CRITICAL: Use the Previous Chapter Reader tool to read and analyze all previously written chapters, with special focus on how the previous chapter ended
       - Consider the overall story progression and how this chapter fits
    
    2. OUTLINE HANDLING: Use the Outline Management tool to:
       - Check if an existing outline exists for this chapter
       - If existing outline found and action is 'expand': Load and enhance it with more detail and structure
       - If no existing outline or action is 'create_new': Generate a completely new outline
    
    Available Context:
    {knowledge_context}
    
    Previous Chapter Context (CRITICAL for continuity):
    {previous_chapter_context}
    
    Existing Draft Material (if any):
    {existing_draft}
    
    Existing Outline (if expanding):
    {existing_outline}
    
    Action to take: {outline_action}
    
    Create a detailed outline for chapter {chapter_number} that includes:
    - Opening scene that DIRECTLY continues from where the previous chapter ended (emotional state, location, immediate situation)
    - Seamless transition that addresses any cliffhangers or unresolved tensions from the previous chapter
    - Key plot points and story progression for this specific chapter that build naturally on previous events
    - Character development moments that acknowledge and build upon their state at the end of the previous chapter
    - World-building elements that maintain consistency with established details
    - Dialogue opportunities that reference recent events and maintain character relationship continuity
    - Action sequences or dramatic moments that feel like natural progression
    - Chapter climax that creates new tension while resolving elements from the previous chapter
    - Setup for the next chapter that maintains story momentum
    
    If expanding an existing outline, enhance it with:
    - Stronger continuity connections to the previous chapter's ending
    - More detailed scene descriptions that acknowledge character states and situations
    - Deeper character motivations that build on recent developments
    - Specific dialogue topics that reference recent events and emotional beats
    - Enhanced pacing notes that create smooth transition from previous chapter
    - Better integration with story knowledge base and previous chapter events
    - Clearer connections to character development and plot threads from previous chapters
    
    CONTINUITY REQUIREMENTS:
    - Chapter must begin exactly where the previous chapter ended (same emotional tone, immediate situation)
    - Address any cliffhangers or unresolved tensions immediately or acknowledge why they're being delayed
    - Reference the character's emotional/physical state from the previous chapter's conclusion
    - Maintain location continuity or provide clear, logical scene transitions
    - Build upon relationship dynamics and tensions established in previous chapters
    
    Target the outline to guide writing a chapter of 2000-4000 words that meaningfully advances the story while maintaining perfect continuity.
    
    IMPORTANT: You must return a complete, detailed chapter outline as your final answer. Do not just provide analysis or comments.
  expected_output: >
    A comprehensive outline for chapter {chapter_number} with:
    - Scene-by-scene breakdown (3-5 scenes typically)
    - Character motivations and development arcs for this chapter
    - Key dialogue topics and emotional beats
    - World-building details to weave naturally into the narrative
    - Pacing notes and estimated word count per section
    - Clear connection points to previous and next chapters
    - Specific story elements from the knowledge base to incorporate
    - References to events, character development, and plot threads from previous chapters
    
    The outline should be structured, detailed, and ready for the writer agent to use as a comprehensive guide.
    If this was an expansion of an existing outline, it should show clear improvements and additional depth.
  agent: architect
  async: false

writing_task:
  description: >
    Using the detailed chapter outline provided by the architect (either from the outline workflow or existing), 
    write a complete chapter in engaging prose that maintains perfect continuity with previous chapters.
    
    Available Context:
    {knowledge_context}
    
    Previous Chapter Context (CRITICAL for continuity):
    {previous_chapter_context}
    
    Chapter Outline to Follow:
    {approved_outline}
    
    CONTINUITY REQUIREMENTS:
    Before writing, you MUST use the Previous Chapter Reader tool to understand exactly how the previous chapter ended.
    Your opening must seamlessly continue from that exact point - same emotional state, immediate situation, and location.
    
    Focus on:
    - Opening that flows directly from the previous chapter's ending (same tone, immediate continuation of situation)
    - Bringing characters to life with authentic dialogue that references recent events and maintains relationship dynamics
    - Creating immersive descriptions that maintain consistency with established settings and world-building
    - Maintaining consistent voice and style throughout while building on previous character development
    - Following the outline structure while ensuring smooth transitions from the previous chapter
    - Building tension and emotional engagement that acknowledges character states from previous events
    - Ensuring narrative flow that feels like one continuous story, not separate episodes
    - Incorporating world-building elements naturally while maintaining established consistency
    - Advancing character arcs that build logically on recent developments and interactions
    - Creating compelling scenes that reference and build upon previous chapter events
    - Resolving or acknowledging any cliffhangers or tensions from the previous chapter
    
    The chapter should feel like a natural, immediate continuation of the story and maintain perfect consistency
    with the established world, characters, relationships, and recent events from previous chapters.
    
    CRITICAL: Do not start fresh or reset the situation. Continue exactly where the story left off.
  expected_output: >
    A complete chapter draft of approximately 2000-4000 words written in engaging prose.
    The chapter should be publication-ready in terms of storytelling quality and should 
    capture the essence of the outline while allowing for natural character interactions, 
    vivid descriptions, and a compelling narrative arc. The writing should be immersive,
    emotionally engaging, and move the story forward meaningfully.
  agent: writer

editing_task:
  description: >
    You're the master editor and prose stylist responsible for transforming a drafted chapter into publication-ready, 
    natural human-feeling prose while ensuring perfect continuity with previous chapters. You must combine both 
    content editing and stylistic polishing in a single comprehensive pass.

    This is Chapter {chapter_number}, with a target length of 2000-4000 words. Your edits should elevate the writing 
    while preserving the author's original voice and ensuring seamless stylistic consistency with previous chapters.

    Previous Chapter Context (for continuity and style consistency):
    {previous_chapter_context}

    MANDATORY PREPARATION STEPS:
    1. Use the Previous Chapter Reader tool to verify continuity and analyze established writing style
    2. Use the Style Analysis tool to get detailed analysis of writing patterns from previous chapters
    3. Use the Style Guide tool to review general guidelines for areas needing focus

    CONTINUITY VERIFICATION:
    Verify that the chapter maintains perfect continuity with previous chapters, especially:
    - Opening connects seamlessly to how the previous chapter ended
    - Character emotional states and relationships are consistent
    - Location and setting details remain consistent
    - Recent events are properly referenced or acknowledged
    - No contradictions with established plot points or character development

    CONTENT EDITING FOCUS:
    - Enhance prose for clarity, rhythm, and emotional resonance while maintaining continuity
    - Make dialogue feel authentic, character-specific, and consistent with recent interactions
    - Avoid making sentence starts too formulaic or repetitive
    - Weave world-building naturally into scenes without contradicting established elements
    - Strengthen scene transitions, especially the opening transition from the previous chapter
    - Identify and fix tonal inconsistencies or continuity breaks
    - Cut overly verbose sections and expand thin areas where needed
    - Ensure the chapter hits a satisfying emotional or plot beat at the end

    STYLE ANALYSIS AND MATCHING:
    Before editing, analyze previous chapters for:
    - Specific sentence structure patterns and rhythms
    - Distinctive metaphor and imagery styles
    - Character voice patterns and dialogue authenticity
    - Atmospheric description techniques and sensory detail usage
    - Balance between intimate character moments and epic world-building
    - Pacing techniques between action, dialogue, and description

    STYLE CONSISTENCY REQUIREMENTS:
    - Mirror the established sentence rhythm patterns from previous chapters
    - Use similar metaphorical language and imagery style
    - Maintain the same level of atmospheric detail and sensory immersion
    - Match the established balance between poetic and accessible language
    - Keep character dialogue consistent with their established voices
    - Preserve the established pacing patterns between action and contemplation
    - Maintain the established emotional authenticity style

    AI PATTERN ELIMINATION AND HUMANIZATION:
    - Remove robotic or formulaic sentence structures
    - Remove the use of "-" (dashes) or other common AI hallmarks
    - Vary sentence length organically to match the established style
    - Eliminate overused transitional phrases when they feel artificial
    - Replace generic descriptive language with specific, evocative details
    - Add subtle imperfections that make prose feel genuinely human-authored
    - Create natural speech patterns with interruptions and realistic flow
    - Make action sequences feel immediate and visceral
    - Ensure character thoughts sound authentic to their established personality

    FANTASY/XIANXIA STYLE ELEMENTS:
    - Maintain the epic scope while keeping character moments intimate
    - Use language that feels both timeless and accessible
    - Create atmosphere through sensory details (sounds, smells, textures)
    - Balance mystical elements with grounded human emotions
    - Ensure world-building details feel naturally integrated, not forced
    - Make cultivation/magic systems feel lived-in rather than explained

    FINAL VERIFICATION:
    - Double-check that the edited chapter could seamlessly follow the previous chapter
    - Ensure no jarring differences in voice, tone, or writing technique
    - Verify that a reader wouldn't notice any shift in author "voice" between chapters
    - Confirm that descriptive techniques, dialogue patterns, and pacing match established style

    The goal is to create prose that feels like it was crafted by the same skilled fantasy author who wrote 
    the previous chapters, with no traces of AI generation and perfect continuity. Preserve all story content 
    while transforming the prose to feel completely natural and human.
  expected_output: >
    A complete, publication-ready chapter between 2000-4000 words that reads like it came from an experienced 
    human fantasy author and maintains perfect continuity with previous chapters. The final version should have 
    strong narrative flow that connects seamlessly to previous events, emotionally grounded character moments 
    that build on recent developments, immersive world details that remain consistent with established elements, 
    and precise, vivid prose that feels naturally human with no AI-generated patterns. The chapter should feel 
    like a seamless continuation of the ongoing story with consistent authorial voice throughout. The text should 
    be completely humanized with natural flow, authenticity, and atmospheric quality of professional fantasy 
    literature. Return the full edited and polished chapter only—no commentary or preamble.
  agent: editor

